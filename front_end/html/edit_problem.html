{% if problem_basics["exists"] %}
    <h2>Edit exercise</h2>
{% else %}
    <h2>Create exercise</h2>
{% end %}

{% if result %}
    {% if result.startswith("Error:") %}
        <p><div class="notification error-message"><strong>{{ result }}</strong></div></p>
    {% elif result.startswith("Code") %}
        <p><pre class="error-message">{{ result }}</pre></p>
    {% else %}
        <p><div class="notification success-message"><strong>{{ result }}</strong></div></p>
    {% end %}
{% end %}

{% if course_basics["exists"] %}
    {% if assignment_basics["exists"] %}
        <!-- Load external libraries -->
        <script src="/static/ace.js" type="text/javascript" charset="utf-8"></script>
        <script src="/static/mode-r.js" type="text/javascript"></script>
        <script src="/static/ext-language_tools.js"></script>

        <!-- Global JavaScript -->
        <script>
            function updateBackEndOptions(back_end, output_type_to_select) {
                // Clear out existing options from the dropdown
                $("#output_types").empty();

                ot_select = document.getElementById("output_types");

                $.get('/back_end/' + back_end, function( data ) {
                    var json_data = JSON.parse(data);

                    var i;
                    for (i = 0; i < Object.keys(json_data["output_types"]).length; i++) {
                        key = Object.keys(json_data["output_types"])[i];
                        description = json_data["output_types"][key];

                        var opt = document.createElement('option');
                        opt.innerHTML = description;
                        opt.value = key;

                        if (output_type_to_select == '') {
                            if (key == "txt")
                                opt.selected = true;
                        }
                        else {
                            if (key == output_type_to_select)
                                opt.selected = true;
                        }

                        ot_select.appendChild(opt);
                    }

                    answer_code_editor.getSession().setMode(json_data["code_completion_path"]);
                    test_code_editor.getSession().setMode(json_data["code_completion_path"]);
                });
            }

            function update_auto_complete(checkbox_element_id) {
                checkbox = document.getElementById(checkbox_element_id);

                editor = answer_code_editor;
                if (checkbox_element_id == "test_code_auto_complete")
                    editor = test_code_editor;

                if (checkbox.checked) {
                    editor.setOptions({
                        enableBasicAutocompletion: false,
                        enableSnippets: true,
                        enableLiveAutocompletion: true
                    });
                }
                else {
                    editor.setOptions({
                        enableBasicAutocompletion: false,
                        enableSnippets: false,
                        enableLiveAutocompletion: false
                    });
                }
            }

            ace.require("ace/ext/language_tools");
        </script>

        <form method="post" action="/edit_problem/{{ course_basics['id'] }}/{{ assignment_basics['id'] }}/{{ problem_basics['id'] }}" id="myForm" />

        <div class="shadow-box">
            <div class="row-container">
                <div class="title-container">
                    <p><strong>Title*: </strong></p>
                    <p><textarea name="title" class="textarea is-info is-normal is-medium is-fullwidth monospace" placeholder="Please specify a descriptive title for this exercise." rows="1" autofocus>{{ problem_basics["title"] }}</textarea></p>
                </div>

                <div>
                    <p><strong>Back end: </strong>
                        <label class="is-primary has-tooltip-multiline has-tooltip-right" data-tooltip="Choose the back end (programming language environment) that will be used to check the students' solution.">
                            <img src="/static/tooltip.png" alt="Tooltip" class="tooltip-img"/>
                        </label>
                        <div class="select is-info">
                            <select name="back_end" onchange="updateBackEndOptions(this.value, '')" class="edit-select">
                            {% for back_end in back_ends %}
                                <option
                                {% if back_end == problem_details["back_end"] %}
                                    selected
                                {% end %}
                                >{{ back_end }}</option>
                            {% end %}
                            </select>
                        </div>
                    </p>
                </div>

                <div>
                    <p><strong>Output type: </strong>
                        <div class="select is-info">
                            <select name="output_type" id="output_types" class="edit-select">
                            </select>
                        </div>
                    </p>
                </div>

                <div>
                    <p><strong>Visible: </strong>
                        <div class="select is-info">
                            <select name="is_visible" class="edit-select">
                            {% if problem_basics["visible"] %}
                                <option value="Yes" selected>Yes</option>
                                <option value="No">No</option>
                            {% else %}
                                <option value="Yes">Yes</option>
                                <option value="No" selected>No</option>
                            {% end %}
                            </select>
                        </div>
                    </p>
                </div>
            </div>

            <div class="instructions-container">
                <p><strong>Instructions*: </strong><br />Please use <a href="https://www.markdownguide.org/basic-syntax/" target='_blank' rel='noopener noreferrer'>Markdown syntax</a> to write instructions for this exercise.</p>
                <p><textarea name="instructions" class="textarea is-info is-normal is-medium is-fullwidth monospace" placeholder="Please provide instructions for this exercise." rows="8">{{ problem_details["instructions"] }}</textarea></p>
            </div>
        </div>

        <div class="shadow-box">
            <p><strong>Credit: </strong>
                <br />If anyone should be given credit for creating this exercise, please indicate that using <a href="https://www.markdownguide.org/basic-syntax/" target='_blank' rel='noopener noreferrer'>Markdown syntax.</a>
            </p>
            <textarea class="textarea is-info is-normal is-medium is-fullwidth monospace" placeholder="Please write the credit statement here." rows="2" name="credit">{{ problem_details["credit"] }}</textarea></p>
    
            <p><strong>Data source: </strong>
                <br />Optionally, you can specify the URL of a data file that students will use on this exercise.
                    If you specify a URL, that file will be downloaded and stored on the server using the name you specify in the second box below. The maximum file size is 10 megabytes.
            </p>
            <p>
                URL: <textarea name="data_url" class="textarea is-info is-normal is-medium is-fullwidth monospace" rows="1">{{ problem_details["data_url"] }}</textarea>
                <br />
                File name: <textarea name="data_file_name" class="textarea is-info is-normal is-medium is-fullwidth monospace" rows="1">{{ problem_details["data_file_name"] }}</textarea>
            </p>
        </div>

        <div class="shadow-box">
            <div>
                <p><strong>Test code: </strong></p>
                <p>Test code can be used to run one or more tests using the student's code. It helps test the integrity of their code rather than its ability to produce the expected output.</p>
                <p>
                    <textarea class="textarea is-info is-normal is-medium is-fullwidth monospace" placeholder="Please provide test code." rows="10" id="test_code" name="test_code">{{ problem_details["test_code"] }}</textarea>
                    <textarea name="test_code_text" id="test_code_text" class="invisible"></textarea>
                    <label class="is-pulled-right has-tooltip-multiline has-tooltip-left" data-tooltip="Auto-completion speeds up the coding process by reducing typos and other common mistakes.">
                        <img src="/static/tooltip.png" alt="Tooltip" class="tooltip-img"/>
                    </label>
                    <label class="checkbox is-pulled-right">
                        Use auto-complete <input type="checkbox" id="test_code_auto_complete" name="test_code_auto_complete" value="true" checked onclick="update_auto_complete('test_code_auto_complete')">
                    </label>
                </p>
            </div>

            <div>
                <p><strong>Show test code: </strong>
                    <div class="select is-info">
                        <select name="show_test_code" class="edit-select">
                        {% if problem_details["show_test_code"] %}
                            <option value="Yes" selected>Yes</option>
                            <option value="No">No</option>
                        {% else %}
                            <option value="Yes">Yes</option>
                            <option value="No" selected>No</option>
                        {% end %}
                        </select>
                    </div>
                </p>
            </div>
        </div>

        <div class="shadow-box">
            <div>
                <p><strong>Solution*: </strong></p>
                <p>Please specify a solution for this exercise. If it requires programming, the solution will be executed, and the output of your solution will be used as the expected output. If the back end is "free_response," your solution itself will be used as the expected output. If the back end is "any_response," you need not enter a solution. Please note: If your solution changes after students have already submitted answers, any students' answers that were previously marked as correct will remain as correct, but only your most recent solution will appear when students view past submissions. This may be confusing to students, so use caution when changing the solution; consider creating a new exercise instead.</p>
                <p>
                    <textarea name="answer_code" id="answer_code" class="textarea is-info is-normal is-medium is-fullwidth monospace" placeholder="Please provide a solution." rows="10">{{ problem_details["answer_code"] }}</textarea>
                    <!-- https://stackoverflow.com/questions/50662513/ace-editor-how-to-move-changed-data-to-post-or-get -->
                    <textarea name="answer_code_text" id="answer_code_text" class="invisible"></textarea>
                    <label class="is-pulled-right has-tooltip-multiline has-tooltip-left" data-tooltip="Auto-completion speeds up the coding process by reducing typos and other common mistakes.">
                        <img src="/static/tooltip.png" alt="Tooltip" class="tooltip-img"/>
                    </label>
                    <label class="checkbox is-pulled-right">
                        Use auto-complete <input type="checkbox" id="answer_code_auto_complete" name="answer_code_auto_complete" value="true" checked onclick="update_auto_complete('answer_code_auto_complete')">
                    </label>
                </p>
            </div>

            <div>
            {% if problem_basics["exists"] %}
                <p><strong>Output:</strong><br />
    
                {% if problem_details["expected_text_output"] != "" %}
                    <p><pre><code>{{ problem_details["expected_text_output"] }}</code></pre></p>
                {% end %}
    
                {% if problem_details["expected_image_output"] != "" %}
                    <p><figure class='img'><img src='data:image/jpg;base64,{{ problem_details["expected_image_output"] }}' width='95%' /></figure></p>
                {% end %}
            {% end %}
            </div>

            <div>
                <p><strong>Show expected output: </strong>
                    <div class="select is-info">
                        <select name="show_expected" class="edit-select">
                        {% if problem_details["show_expected"] %}
                            <option value="Yes" selected>Yes</option>
                            <option value="No">No</option>
                        {% else %}
                            <option value="Yes">Yes</option>
                            <option value="No" selected>No</option>
                        {% end %}
                        </select>
                    </div>
                </p>
            </div>
        </div>

        <div class="shadow-box">
            <div>
                <p><strong>Answer description:</strong><br />Please use <a href="https://www.markdownguide.org/basic-syntax/" target='_blank' rel='noopener noreferrer'>Markdown syntax</a> to write a tutorial that describes your solution to this exercise.</p> 
                <p><textarea class="textarea is-info is-normal is-medium is-fullwidth monospace" placeholder="Please write in Markdown." rows="5" name="answer_description">{{ problem_details["answer_description"] }}</textarea></p>  
            </div>

            <div class="hint-container">
                <p><strong>Problem hint:</strong><br />Please use <a href="https://www.markdownguide.org/basic-syntax/" target='_blank' rel='noopener noreferrer'>Markdown syntax</a> to write an optional hint for this problem.</p> 
                <p><textarea class="textarea is-info is-normal is-medium is-fullwidth monospace" placeholder="Please write in Markdown." rows="3" name="hint">{{ problem_details["hint"] }}</textarea></p>  
            </div>

            <div class="row-container">
                <div>
                    <p><strong>Allow students to view the instructor's solution after they pass the exercise: </strong>
                        <div class="select is-info">
                            <select name="show_answer" class="edit-select" onchange="showStudentSubmissionsDiv(this.value)">
                            {% if problem_details["show_answer"] %}
                                <option value="Yes" selected>Yes</option>
                                <option value="No">No</option>
                            {% else %}
                                <option value="Yes">Yes</option>
                                <option value="No" selected>No</option>
                            {% end %}
                            </select>
                        </div>
                    </p>
                </div>

                <div>
                    <p><strong>Allow students to see submissions from other students: </strong>
                        <div class="select is-info">
                            <select name="show_student_submissions" id="show_student_submissions" class="edit-select">
                            {% if problem_details["show_student_submissions"] %}
                                <option value="Yes" selected>Yes</option>
                                <option value="No">No</option>
                            {% else %}
                                <option value="Yes">Yes</option>
                                <option value="No" selected>No</option>
                            {% end %}
                            </select>
                        </div>
                    </p>
                </div>
                
                <div>
                    <p><strong>Maximum # of submissions:</strong></p>
                    <p>
                        <div class="select is-info">
                            <select name="max_submissions" class="edit-select">
                            {% for i in range(101) %}
                                {% if i == 0 %}
                                    {% if problem_details["max_submissions"] == i %}
                                        <option value="0" selected>Unlimited</option>
                                    {% else %}
                                        <option value="0">Unlimited</option>
                                    {% end %}
                                {% else %}
                                    {% if problem_details["max_submissions"] == i %}
                                        <option selected>{{ i }}</option>
                                    {% else %}
                                        <option>{{ i }}</option>
                                    {% end %}
                                {% end %}
                            {% end %}
                            </select>
                        </div>
                    </p>
                </div>
            </div>
        </div>

        <p><input type="submit" class="button is-info is-large is-fullwidth is-rounded" value="Save" /></p>

        <p>
        {% if problem_basics["exists"] %}
            <a href="/problem/{{ course_basics['id'] }}/{{ assignment_basics['id'] }}/{{ problem_basics['id'] }}">Done editing</a> |
        {% end %}
            <a href="#top">Back to top</a>
        </p>

        <!-- Code to modify page behavior at the end of loading -->
        <script>
            var answer_code_editor = ace.edit("answer_code", {
                theme: "ace/theme/{{ user_info['ace_theme'] }}",
                autoScrollEditorIntoView: true,
                minLines: 10,
                maxLines: 25,
                fontSize: "12pt"
            });

            var test_code_editor = ace.edit("test_code", {
                theme: "ace/theme/{{ user_info['ace_theme'] }}",
                autoScrollEditorIntoView: true,
                minLines: 10,
                maxLines: 15,
                fontSize: "12pt"
            });

            updateBackEndOptions('{{ problem_details["back_end"] }}', '{{ problem_details["output_type"] }}');
            update_auto_complete('answer_code_auto_complete');
            update_auto_complete('test_code_auto_complete');

            document.getElementById("myForm").onsubmit = function(evt) {
                document.getElementById("answer_code_text").value = answer_code_editor.getValue();
                document.getElementById("test_code_text").value = test_code_editor.getValue();
            } 

        </script>
        </form>
    {% else %}
        This assignment has not been created yet.
    {% end %}
{% else %}
    This course has not been created yet.
{% end %}
<br /><br />
