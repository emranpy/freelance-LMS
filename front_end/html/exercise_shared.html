            <link rel="stylesheet" href="/static/modal.css">

            <script>
                function run_code() {
                    user_code = editor.getSelectedText();
                    if (user_code.trim() == "")
                        user_code = editor.getValue();
                    if (user_code.trim() == "")
                        return false;

                    showWaitMessage();

                    $.ajax({
                        type: 'POST',
                        url: "/run_code/{{ course_basics['id'] }}/{{ assignment_basics['id'] }}/{{ exercise_basics['id'] }}",
                        data: {"user_code": user_code},
                        success: function(result) {
                            var response_dict = JSON.parse(result);

                            if (response_dict["message"] != "") {
                                showErrorMessage(response_dict["message"]);
                                return;
                            }

                            if (allTestsPassed(response_dict["test_outputs"])) {
                                showSuccessMessage();
                            }
                            else {
                                hideWaitMessage();
                            }

                            showTestOutputs(response_dict["test_outputs"]);

                            // Build test buttons
                            //build_tests_output(response_dict);

                            //TODO: Do the same AJAX error handling we are doing in edit_exercise.
                        },
                        async: true
                    });

                    editor.focus();
                    return false;
                }

                async function submit() {
                    user_code = editor.getValue();

                    if (user_code.trim() == "")
                        return false;

                    // Get partner_id
                    let partner_key = document.getElementById("partner_key").value != "" ? document.getElementById("partner_key").value : null;

                    result_div = document.getElementById("result");
                    result_div.innerHTML = "<div class='notification is-warning is-light smaller-font'>Please wait while your solution is being executed...</div>";
                    result_div.scrollIntoView();

                    // if not exercise_details["allow_any_response"]
                        document.getElementById("code_output").innerHTML = "";

                        // if exercise_details["show_expected"]
                            document.getElementById("diff_output").innerHTML = "";

                    post_data = { "partner_key": partner_key, "user_code": user_code, "date": new Date().toLocaleString("en-US", {timeZone: "UTC"})};

                    await $.post("/submit/{{ course_basics['id'] }}/{{ assignment_basics['id'] }}/{{ exercise_basics['id'] }}",
                        post_data,

                        function(data, status) {
                            json_data = JSON.parse(data);
                            display_results(json_data);
 
                            if (json_data.submission_id != "") {
                                last_submission_id = json_data.submission_id;

                                {% if exercise_details["max_submissions"] > 0 %}
                                    document.getElementById("num_submissions").innerHTML = last_submission_id;

                                    if (last_submission_id >= {{ exercise_details["max_submissions"] }})
                                        document.getElementById("submit_button").disabled = true;
                                {% end %}
                            }
                        });

                    editor.focus();

                    await show_past_submission_buttons();
                    return false;
                }

                function showWaitMessage() {
                    $("#result")[0].innerHTML = "<div class='notification is-warning is-light smaller-font'>Please wait while your solution is being executed...</div>";
                    $("#result")[0].scrollIntoView();
                }

                function hideWaitMessage() {
                    $("#result")[0].innerHTML = "";
                }

                function showErrorMessage(message) {
                    $("#result")[0].innerHTML = `<div class='notification error-message smaller-font' style='color: white'><pre>${message}</pre></div>`;
                    $("#result")[0].scrollIntoView();
                }

                function showSuccessMessage(message) {
                    {% if exercise_details["allow_any_response"] %}
                        var result = "<div class='notification success-message' style='color:white'><p><strong>Thank you for your submission.</strong></p>";
                    {% else %}
                        {% if len(exercise_details["tests"]) == 1 %}
                            var result = "<div class='notification success-message smaller-font' style='color:white'><p><strong>Congratulations! Your solution produced the expected output.</strong></p>";
                        {% else %}
                            var result = "<div class='notification success-message smaller-font' style='color:white'><p><strong>Congratulations! Your solution passed all of the tests.</strong></p>";
                        {% end %}
                    {% end %}

                    {% if exercise_details["show_peer_solutions"] %}
                        result += "<p><a class='grey-text' href='/view_answer/{{ course_basics['id'] }}/{{ assignment_basics['id'] }}/{{ exercise_basics['id'] }}'>View other students' solutions</a></p>";
                    {% elif exercise_details["show_instructor_solution"] and (exercise_details["solution_code"] != "" or exercise_details["solution_description"] != "") %}
                        result += "<p><a class='grey-text' href='/view_answer/{{ course_basics['id'] }}/{{ assignment_basics['id'] }}/{{ exercise_basics['id'] }}'>View the instructor's solution</a></p>";
                    {% end %}

                    {% if next_exercise %}
                        result += "<p><a class='grey-text' href='/exercise/{{ course_basics['id'] }}/{{ assignment_basics['id'] }}/{{ next_exercise['id'] }}'>Next exercise</a></p>\n\n";
                    {% end %}

                    result += "</div>"

                    $("#result")[0].innerHTML = result;
                    $("#result")[0].scrollIntoView();
                }

                function allTestsPassed(test_outputs) {
                    for (let test_title of Object.keys(test_outputs))
                        if (!test_outputs[test_title]["passed"])
                            return false;
                    return true;
                }

                function showTestOutputs(test_outputs) {
                    // This is what we do if we haven't gone to the server yet.
                    if (test_outputs == null) {
                        test_outputs = {};
                        for (let test_title of Object.keys(tests)) {
                            test_outputs[test_title] = {};
                            test_outputs[test_title]["txt_output"] = null;
                            test_outputs[test_title]["jpg_output"] = null;
                            test_outputs[test_title]["passed"] = null;
                        }
                    }

                    if (Object.keys(test_outputs).length == 1) {
                        var output = "<h6>Test:</h6>" + buildTestOutput(test_outputs, Object.keys(test_outputs)[0], false, true);
                    } else {
                        var output = "<h6>Tests:</h6>";

                        const test_titles = Object.keys(test_outputs)
                        for (let test_title of test_titles) {
                            //output += "<p>" + test_title + "</p>";
                            output += buildTestOutput(test_outputs, test_title, true, test_title == test_titles[test_titles.length - 1]);
                        }
                    }

                //        document.getElementById('test_output').style.display = "block";

                //        if (json_data == null) {
                //            button_bd_color = "neutral-bd-color";
                //            test_message = "";

                //        } else {
                //            button_bd_color = json_data.tests[test_title].passed ? "passing-bd-color" : "failing-bd-color";
                //            test_message = json_data.tests[test_title].passed ? "passed." : "did not pass.";
                //        }

                //        test_output += `<div class='${button_bd_color} test-content' style='cursor:pointer;'>`;
                        //test_output += `<div class='${button_bd_color} test-content' style='cursor:pointer;' onclick='showTest(test_title)'>`;
                        //test_output += `<h6 style="padding: 1em 1.25em;margin:0">test_title ${test_message}</h6>`;

                        // This defines the box that surrounds each test.
                //        test_output += `<div id="test_test_title" style="padding: 0.5em 1.25em 0.5em 1.25em;margin:0">`;

                //        if exercise_details["tests"][test_title]["visible"]
                //            test_output += `<h6 style="padding: 0.5em 0em 0.5em 0em;margin:0">Test code:</h6>`;
                //            test_output += `<pre style="padding: 0.5em 0em 0.5em 0em;margin:0">exercise_details["tests"][test_title]["code"]</pre>`;

                //            test_output += `<h6 style="padding: 0.5em 0em 0.5em 0em;margin:0">Expected output:</h6>\n\n`;

                //            if exercise_details["output_type"] == "txt"
                //                test_output += `<pre style="padding: 0.5em 0em 0.5em 0em;margin:0">exercise_details["tests"][test_title]["txt_output"]</pre>`;
                //            else
                //                test_output += `<p style="padding: 0.5em 0em 0.5em 0em;margin:0"><figure class='img'><img src='data:image/jpg;base64,` + 'exercise_details["tests"][test_title]["jpg_output"]' + `' width='100%' /></figure></p>`;

                //            if (json_data != null && json_data.tests[test_title].diff_output != "") {
                //                test_output += `<h6 style="padding: 0.5em 0em 0.5em 0em;margin:0">Difference between your output and the expected output:</h6>\n\n`;

                //                if exercise_details["output_type"] == "txt"
                //                     test_output += `<pre style="padding: 0.5em 0em 0.5em 0em;margin:0">` + json_data.tests[test_title].diff_output + "</pre>\n\n";
                //                     test_output += `<p style="padding: 0.5em 0em 0.5em 0em;margin:0"><em>A <code>+</code> in brackets indicates that your output had an extra character.<br />A <code>-</code> in brackets indicates that your output was missing the specified character.</em></p>`;
                //                else
                //                     test_output += `<p style="padding: 0.5em 0em 0.5em 0em;margin:0"><figure class='img'><img src='data:image/jpg;base64,` + json_data.tests[test_title].diff_output + `' width='100%' /></figure></p><br />`;
                //            }
                //        else
                //            test_output += `<h6 style="padding: 0.5em 0em 0.5em 0em;margin:0">Details for this test are hidden from students.`;

                //            if exercise_details["tests"][test_title]["test_instructions"] != ""
                //                test_output += ` However, the instructor provided the following instructions.</h6>`;
                //                test_output += `<p style="padding: 0.5em 0em 0.5em 0em;margin:0">exercise_details["tests"][test_title]["test_instructions"]</p>`;
                //            else
                //                test_output += "</h6>";

                //        if (json_data != null) {
                //            test_output += `<h6 style="padding: 0.5em 0em 0.5em 0em;margin:0">Your output:</h6>\n\n`;

                //            if exercise_details["output_type"] == "txt"
                //                if (json_data.tests[test_title].txt_output == "")
                //                    test_output += `<pre style="padding: 0.5em 0em 0.5em 0em;margin:0">[Your solution produced no output.]</pre>`;
                //                else
                //                    test_output += `<pre style="padding: 0.5em 0em 0.5em 0em;margin:0">${json_data.tests[test_title].txt_output}</pre>`;
                //            else
                //                if (json_data.tests[test_title]["jpg_output"] == "")
                //                    test_output += `<pre style="padding: 0.5em 0em 0.5em 0em;margin:0">[Your solution did not produce an image.]</pre>`;
                //                else
                //                    test_output += "<p><figure class='img'><img src='data:image/jpg;base64," + json_data.tests[test_title].jpg_output + "' width='100%' /></figure></p>";

                //                if (json_data.tests[test_title]["txt_output"] != "")
                //                    test_output += `<pre style="padding: 0.5em 0em 0.5em 0em;margin:0">${json_data.tests[test_title].txt_output}</pre>`;
                //        }

                //        test_output += `</div></div>`
                //        test_output += `<br />`

                //        document.getElementById("test_output").innerHTML = test_output;
                    $("#test_outputs")[0].innerHTML = output;
                }

                function buildTestOutput(test_outputs, test_title, show_title, is_last) {
                    if (test_outputs[test_title].passed == null) {
                        var test_class = "neutral-bd-color";
                        var test_message = show_title ? test_title : "";
                    }
                    else {
                        if (test_outputs[test_title].passed) {
                            var test_class = "passing-bd-color";

                            if (show_title)
                                var test_message = `${test_title} - Passing`;
                            else
                                var test_message = `Passing`;
                        }
                        else {
                            var test_class = "failing-bd-color";

                            if (show_title)
                                var test_message = `${test_title} - Not passing`;
                            else
                                var test_message = `Not passing`;
                        }
                    }

                    if (is_last)
                        var output = `<div class='${test_class}' style="font-size: 1em; margin-bottom: 0px">`;
                    else
                        var output = `<div class='${test_class}' style="font-size: 1em; margin-bottom: 10px">`;

                    if (test_message == "")
                        output += `<div style="padding: 0.75em 0.5em 0em 1.25em;margin:0"> </div>`;
                    else
                        output += `<h6 style="padding: 0.75em 0.5em 0.25em 1.25em;margin:0">${test_message}</h6>`;

                    output += '<div style="padding: 0em 1.25em 0.75em 1.25em">';

                    if (tests[test_title].can_see_test_code) {
                        if (tests[test_title].before_code != "") {
                            var message = '<div style="padding: 0.5em 0em 0.5em 0em;margin:0">Code that will be executed before your code:</div>';
                            if (test_outputs[test_title].passed != null)
                                message = '<div style="padding: 0.5em 0em 0.5em 0em;margin:0">Code that was executed before your code:</div>';

                            //output += message + '<pre style="padding: 1.25em 0.5em 1.25em 0.75em;margin:0">' + tests[test_title].before_code + '</pre>';
                            output += message + '<pre style="padding: 0.75em 0.5em 0.75em 0.75em;margin:0">' + tests[test_title].before_code + '</pre>';
                        }

                        if (tests[test_title].after_code != "") {
                            var message = '<div style="padding: 0.5em 0em 0.5em 0em;margin:0">Code that will be executed after your code:</div>';
                            if (test_outputs[test_title].passed != null)
                                message = '<div style="padding: 0.5em 0em 0.5em 0em;margin:0">Code that was executed after your code:</div>';

                            //output += message + '<pre style="padding: 1.25em 0.5em 1.25em 0.75em;margin:0">' + tests[test_title].after_code + '</pre>';
                            output += message + '<pre style="padding: 0.75em 0.5em 0.75em 0.75em;margin:0">' + tests[test_title].after_code + '</pre>';
                        }
                    }
                    else {
                        output += '<div style="padding: 0.5em 0em 0.5em 0em;margin:0"><em>The test code will not be shown for this test.</em></div>';
                    }

                    if (tests[test_title].can_see_expected_output) {
                        var expected_output = "";

                        if (tests[test_title]["txt_output"] != null && tests[test_title]["txt_output"] != "") {
                            expected_output += '<pre style="padding: 0.75em 0.5em 0.75em 0.75em;margin:0">' + tests[test_title]["txt_output"] + '</pre>';
                        }

                        if (tests[test_title]["jpg_output"] != null && tests[test_title]["jpg_output"] != "") {
                            expected_output += '<p style="padding: 0em 0em 0em 0em;margin:0"><img src="data:image/jpg;base64,' + tests[test_title]["jpg_output"] + '" width="100%" /></p>';
                        }

                        output += '<div style="padding: 0.5em 0em 0.5em 0em;margin:0">Expected output:</div>' + expected_output;
                    }
                    else {
                        output += '<div style="padding: 0.5em 0em 0.5em 0em;margin:0"><em>The expected output will not be shown for this test.</em></div>';
                    }

                    if (test_outputs[test_title].passed != null) {
                        if (tests[test_title].can_see_code_output) {
                            var user_output = "";

                            if (test_outputs[test_title]["txt_output"] != null && test_outputs[test_title]["txt_output"] != "") {
                                user_output += '<pre style="padding: 0.75em 0.5em 0.75em 0.75em;margin:0">' + test_outputs[test_title]["txt_output_formatted"] + '</pre>';
                            }

                            if (test_outputs[test_title]["jpg_output"] != null && test_outputs[test_title]["jpg_output"] != "") {
                                user_output += '<p style="padding: 0em 0em 0em 0em;margin:0"><img src="data:image/jpg;base64,' + test_outputs[test_title]["jpg_output"] + '" width="100%" /></p>';
                            }

                            if (user_output != "")
                                output += '<div style="padding: 0.5em 0em 0.5em 0em;margin:0">Your output:</div>' + user_output;

                            if (test_outputs[test_title]["diff_output"] != null && test_outputs[test_title]["diff_output"] != "") {
                                output += `<div style="padding: 0.5em 0em 0.5em 0em;margin:0">Difference between your output and the expected output:</div>`;

                                {% if exercise_details["output_type"] == "txt" %}
                                    output += `<pre style="padding: 0.5em 0em 0.5em 0em;margin:0">` + test_outputs[test_title]["diff_output"] + "</pre>";
                                    output += `<p style="padding: 0.5em 0em 0.5em 0em;margin:0"><em>A <code>+</code> in brackets indicates that your output had an extra character.<br />A <code>-</code> in brackets indicates that your output was missing the specified character.</em></p>`;
                                {% else %}
                                    output += '<p style="padding: 0em 0em 0em 0em;margin:0"><img src="data:image/jpg;base64,' + test_outputs[test_title]["diff_output"] + '" width="100%" /></p>';
                                    output += `<p style="padding: 0.5em 0em 0.5em 0em;margin:0"><em>Black indicates parts of the image that are identical to the expected output. White indicates parts of the image that are different from the expected output.</em></p>`;
                                {% end %}
                            }
                        }
                        else {
                            output += '<div style="padding: 0.5em 0em 0.5em 0em;margin:0"><em>Your output will not be shown for this test.</em></div>';
                        }
                    }

                    //TODO: Submit button not working.
                    //TODO: Make sure it works when the back end is down ("message" != "").
                    //TODO: Show previous submission buttons. If they have submitted previously, show that when the page loads.

                    output += `</div>`;
                    output += `</div>`;

                //        if exercise_details["tests"][test_title]["visible"]
                //            test_output += `<h6 style="padding: 0.5em 0em 0.5em 0em;margin:0">Test code:</h6>`;
                //            test_output += `<pre style="padding: 0.5em 0em 0.5em 0em;margin:0">exercise_details["tests"][test_title]["code"]</pre>`;

                //            test_output += `<h6 style="padding: 0.5em 0em 0.5em 0em;margin:0">Expected output:</h6>\n\n`;

                //            if exercise_details["output_type"] == "txt"
                //                test_output += `<pre style="padding: 0.5em 0em 0.5em 0em;margin:0">exercise_details["tests"][test_title]["txt_output"]</pre>`;
                //            else
                //                test_output += `<p style="padding: 0.5em 0em 0.5em 0em;margin:0"><figure class='img'><img src='data:image/jpg;base64,` + 'exercise_details["tests"][test_title]["jpg_output"]' + `' width='100%' /></figure></p>`;

                //            if (json_data != null && json_data.tests[test_title].diff_output != "") {
                //                test_output += `<h6 style="padding: 0.5em 0em 0.5em 0em;margin:0">Difference between your output and the expected output:</h6>\n\n`;

                //                if exercise_details["output_type"] == "txt"
                //                     test_output += `<pre style="padding: 0.5em 0em 0.5em 0em;margin:0">` + json_data.tests[test_title].diff_output + "</pre>\n\n";
                //                     test_output += `<p style="padding: 0.5em 0em 0.5em 0em;margin:0"><em>A <code>+</code> in brackets indicates that your output had an extra character.<br />A <code>-</code> in brackets indicates that your output was missing the specified character.</em></p>`;
                //                else
                //                     test_output += `<p style="padding: 0.5em 0em 0.5em 0em;margin:0"><figure class='img'><img src='data:image/jpg;base64,` + json_data.tests[test_title].diff_output + `' width='100%' /></figure></p><br />`;
                //            }
                //        else
                //            test_output += `<h6 style="padding: 0.5em 0em 0.5em 0em;margin:0">Details for this test are hidden from students.`;

                //            if exercise_details["tests"][test_title]["test_instructions"] != ""
                //                test_output += ` However, the instructor provided the following instructions.</h6>`;
                //                test_output += `<p style="padding: 0.5em 0em 0.5em 0em;margin:0">exercise_details["tests"][test_title]["test_instructions"]</p>`;
                //            else
                //                test_output += "</h6>";

                //        if (json_data != null) {
                //            test_output += `<h6 style="padding: 0.5em 0em 0.5em 0em;margin:0">Your output:</h6>\n\n`;

                //            if exercise_details["output_type"] == "txt"
                //                if (json_data.tests[test_title].txt_output == "")
                //                    test_output += `<pre style="padding: 0.5em 0em 0.5em 0em;margin:0">[Your solution produced no output.]</pre>`;
                //                else
                //                    test_output += `<pre style="padding: 0.5em 0em 0.5em 0em;margin:0">${json_data.tests[test_title].txt_output}</pre>`;
                //            else
                //                if (json_data.tests[test_title]["jpg_output"] == "")
                //                    test_output += `<pre style="padding: 0.5em 0em 0.5em 0em;margin:0">[Your solution did not produce an image.]</pre>`;
                //                else
                //                    test_output += "<p><figure class='img'><img src='data:image/jpg;base64," + json_data.tests[test_title].jpg_output + "' width='100%' /></figure></p>";

                //                if (json_data.tests[test_title]["txt_output"] != "")
                //                    test_output += `<pre style="padding: 0.5em 0em 0.5em 0em;margin:0">${json_data.tests[test_title].txt_output}</pre>`;
                //        }

                    return output;
                }

                function submitModal() {
                    var modal = document.getElementById("submit_exercise_modal");
                    var span = document.getElementsByClassName("close")[4];

                    modal.style.display = "block";

                    var cancelButton = document.getElementById("submit_cancel_button");
                    var modalSubmitButton = document.getElementById("modal_submit_button");

                    modalSubmitButton.onclick = function() {
                        let partner_key = document.getElementById("partner_key").value;
                        if (partner_key != "") {
                            $.post("/check_partners/{{ course_basics['id'] }}", {"partner_key": partner_key},
                                function(data, status) {
                                    if(!(JSON.parse(data))) {
                                        document.getElementById("invalid_partner").innerHTML = "<div style='margin:15px 0px' class='space_div notification is-warning is-light smaller-font'>Invalid partner chosen, please try again.</div>";
                                    } else {
                                        submit();
                                        modal.style.display = "none";
                                    }
                                });
                        } else {
                            submit();
                            modal.style.display = "none";
                        }
                    }

                    cancelButton.onclick = function() {
                        modal.style.display = "none";
                    }

                    span.onclick = function() {
                        modal.style.display = "none";
                    }

                    window.onclick = function(event) {
                        if (event.target == modal) {
                            modal.style.display = "none";
                        }
                    }
                }

                function get_submission(submission_id, scroll, check_for_presubmission) {
                    var submission_buttons = document.getElementsByClassName('button is-primary is-medium');
                    if (document.getElementById("saved_div") != null)
                        document.getElementById("saved_div").innerHTML = "";

                    var i;
                    for (i = 0; i < submission_buttons.length; i++) {
                        if (submission_buttons[i].id == submission_id)
                            submission_buttons[i].style.border = "solid #34495e";
                        else
                            submission_buttons[i].style.border = "none";
                    }

                    {% if not exercise_details["allow_any_response"] %}
                        document.getElementById("code_output").innerHTML = "";

                        // if exercise_details["show_expected"]
                            document.getElementById("diff_output").innerHTML = "";
                    {% end %}

                    // if exercise_details["show_expected"] and not exercise_details["allow_any_response"]
                        document.getElementById("diff_output").innerHTML = "";

                    $.get("/get_submission/{{ course_basics['id'] }}/{{ assignment_basics['id'] }}/{{ exercise_basics['id'] }}/{{ student_id }}/" + submission_id + `/${check_for_presubmission}` ,
                        function (data, status) {
                            var json_data = JSON.parse(data);
                            editor.setValue(json_data.code, -1);

                            if (json_data.using_presubmission)
                                if (document.getElementById("saved_div") != null)
                                    document.getElementById("saved_div").innerHTML = "Code loaded from last session.";

                            display_results(json_data);
                        });

                    if (scroll && document.getElementById("your_code_header") != null)
                        document.getElementById("your_code_header").scrollIntoView();

                    editor.focus();
                    return false;
                }

                function show_past_submission_buttons() {
                    submissions_div = document.getElementById("submissions");

                    $.get("/get_submissions/{{ course_basics['id'] }}/{{ assignment_basics['id'] }}/{{ exercise_basics['id'] }}/{{ student_id }}",
                        function (data, status) {
                            var json_data = JSON.parse(data);
                            var submission_html = "";
                            var revert_html = "";
                            var current_code = editor.getValue()

                            if (json_data.length > 0) {
                                submission_html += "<h6>Past submissions:</h6>\n";
                                submission_html += "<div class='buttons'>\n";
                                var i;

                                for (i = 0; i < json_data.length; i++) {
                                    submission_id = json_data[i][0];
                                    the_date = json_data[i][1];
                                    passed = json_data[i][2];
                                    partner_name = json_data[i][3]

                                    if (passed)
                                        button_bd_color = "passing-btn-color";
                                    else
                                        button_bd_color = "failing-btn-color";

                                    var submission_date = new Date(the_date).toLocaleString();

                                    if (partner_name)
                                        submission_html += `<button class='button ${button_bd_color}' id='${submission_id}' style='display: block; width: 315px;' onclick='get_submission(${submission_id}, true, false)'><b>${submission_id}.</b> ${submission_date} <label class="has-tooltip-multiline has-tooltip-right" data-tooltip="Pair programmed with ${partner_name}."><i class="fab fa-product-hunt"></i></label></button>`;
                                    else
                                        submission_html += `<button class='button ${button_bd_color}' id='${submission_id}' style='display: block; width: 315px;' onclick='get_submission(${submission_id}, true, false)'><b>${submission_id}.</b> ${submission_date}</button>`;
                                }

                                submission_html += "</div><br />\n";
                            }

                            submissions_div.innerHTML = submission_html;
                        });
                }

                function get_presubmission() {
                    $.get("/get_presubmission/{{ course_basics['id'] }}/{{ assignment_basics['id'] }}/{{ exercise_basics['id'] }}/{{ student_id }}",
                        function (data, status) {
                            if (data.length > 0) {
                                editor.setValue(data, -1);
                            }
                        });
                }

                function save_presubmission(autosave) {
                    user_code = editor.getValue();
                    if (user_code.trim() == "")
                        return false;

                    saved_div = document.getElementById("saved_div");
                    saved_div.innerHTML = "Please wait while your code is being saved...";

                    $.ajax({
                        type: 'POST',
                        url: "/save_presubmission/{{ course_basics['id'] }}/{{ assignment_basics['id'] }}/{{ exercise_basics['id'] }}",
                        data: {"user_code": user_code},
                        success: function(result) {
                            if (result == "") {
                                codeChanged = false;

                            last_saved_at = new Intl.DateTimeFormat('default', {
                                hour: 'numeric',
                                minute: 'numeric',
                            }).format(Date.now());

                            if (autosave)
                                saved_div.innerHTML = `Auto-saved at ${last_saved_at}.`;
                            else
                                saved_div.innerHTML = `Saved at ${last_saved_at}.`;
                           }
                           else {
                               console.log("An error occurred when the user attempted to save their code. The error message is below.");
                               console.log(result);
                               saved_div.innerHTML = "An error occurred, so your code may not have saved. If this error persists, please contact the instructor.";
                           }
                        },
                        async: false
                    });
                }

                function display_results(json_data) {
                    var result = "";

                    if (json_data.passed) {
console.log("passed11");
                        {% if exercise_details["allow_any_response"] %}
                            result = "<div class='notification success-message' style='color:white'><p><strong>Thank you for your submission.</strong></p>";
                        {% else %}
                            result = "<div class='notification success-message smaller-font' style='color:white'><p><strong>Congratulations! Your solution produces the expected output.</strong></p>";
                        {% end %}

                        {% if exercise_details["show_peer_solutions"] %}
                            result += "<p><a class='grey-text' href='/view_answer/{{ course_basics['id'] }}/{{ assignment_basics['id'] }}/{{ exercise_basics['id'] }}'>View others' solutions</a></p>";
                        {% elif exercise_details["show_instructor_solution"] and (exercise_details["solution_code"] != "" or exercise_details["solution_description"] != "") %}
                            result += "<p><a class='grey-text' href='/view_answer/{{ course_basics['id'] }}/{{ assignment_basics['id'] }}/{{ exercise_basics['id'] }}'>View the instructor's solution</a></p>";
                        {% end %}

                        {% if next_exercise %}
                            result += "<p><a class='grey-text' href='/exercise/{{ course_basics['id'] }}/{{ assignment_basics['id'] }}/{{ next_exercise['id'] }}'>Next exercise</a></p>";
                        {% end %}

                        result += "</div>\n\n"
                    }
                    else {
console.log("failed11");
                        {% if exercise_details["allow_any_response"] %}
                            result = "<div class='notification error-message smaller-font' style='color: white'><p><strong>Your solution did not produce any output.</strong></p></div>";
                        {% else %}
                            result = "<div class='notification error-message smaller-font' style='color: white'><p><strong>Your solution did not pass.</strong></p>\n\n<p>The output does not match the expected output. Please modify your solution and try again.</div>\n\n";
                        {% end %}

                        // if not exercise_details["allow_any_response"] and exercise_details["show_expected"]
                            var diff_output = "";

                            if (json_data.diff.length > 0) {
                                diff_output += "<h6>Difference between your output and the expected output:</h6>\n\n";
                                {% if exercise_details["output_type"] == "txt" %}
                                    diff_output += "<p><pre>" + json_data.diff + "</pre></p>\n\n<p><em>A <code>+</code> in brackets indicates that your output had an extra character.<br />A <code>-</code> in brackets indicates that your output was missing the specified character.</em></p>";
                                {% else %}
                                    //diff_output += "<p><figure class='img'><img src='data:image/jpg;base64," + json_data.diff + "' width='100%' /></figure></p>";
                                {% end %}
                            }

                            document.getElementById("diff_output").innerHTML = diff_output;
                    }

                    document.getElementById("result").innerHTML = result;

                    {% if exercise_details["allow_any_response"] %}
                        if (json_data.txt_output != "" || json_data.jpg_output != "") {
                            var code_output = "<h6>Your output:</h6>\n\n";

                            code_output += build_txt_output(json_data.txt_output);
                            code_output += build_jpg_output(json_data.jpg_output);
                            document.getElementById("code_output").innerHTML = code_output;
                        }
                    {% else %}
                        var expected_text = `exercise_details["expected_txt_output"]`;
                        var expected_image = `exercise_details["expected_jpg_output"]`;

                        // If output includes an index error, provide student with a more helpful error message instead.
                        if (json_data.txt_output.includes("IndexError:&nbsp;list&nbsp;index&nbsp;out&nbsp;of&nbsp;range")) {
                            var code_output = "<h6>Your output:</h6>\n\n";
                            code_output += "Output is not available for this submission. This may be due to the instructor editing the exercise since you last submitted."
                            document.getElementById("code_output").innerHTML = code_output;
                        }
                        else if (((json_data.txt_output != "") || (json_data.jpg_output != "")) || ((expected_text != "") || (expected_image != ""))) {
                            var code_output = "<h6>Your output:</h6>\n\n";
                            code_output += build_txt_output(json_data.txt_output);
                            code_output += build_jpg_output(json_data.jpg_output);
                            document.getElementById("code_output").innerHTML = code_output;
                        }

                        // Build test buttons
                        //build_tests_output(json_data);
                    {% end %}
                }

                //function build_tests_output(json_data) {
                //    var expected_tests = document.getElementById("expected_tests");

                //    if (expected_tests != null) {
                //        expected_tests.style.display = "none";
                //    }

                //    var test_output = "<h6>Tests:</h6>\n\n";

                //    for test_title in exercise_details["tests"]
                //        document.getElementById('test_output').style.display = "block";

                //        if (json_data == null) {
                //            button_bd_color = "neutral-bd-color";
                //            test_message = "";

                //        } else {
                //            button_bd_color = json_data.tests[test_title].passed ? "passing-bd-color" : "failing-bd-color";
                //            test_message = json_data.tests[test_title].passed ? "passed." : "did not pass.";
                //        }

                //        test_output += `<div class='${button_bd_color} test-content' style='cursor:pointer;'>`;
                        //test_output += `<div class='${button_bd_color} test-content' style='cursor:pointer;' onclick='showTest(test_title)'>`;
                        //test_output += `<h6 style="padding: 1em 1.25em;margin:0">test_title ${test_message}</h6>`;

                        // This defines the box that surrounds each test.
                //        test_output += `<div id="test_test_title" style="padding: 0.5em 1.25em 0.5em 1.25em;margin:0">`;

                //        if exercise_details["tests"][test_title]["visible"]
                //            test_output += `<h6 style="padding: 0.5em 0em 0.5em 0em;margin:0">Test code:</h6>`;
                //            test_output += `<pre style="padding: 0.5em 0em 0.5em 0em;margin:0">exercise_details["tests"][test_title]["code"]</pre>`;

                //            test_output += `<h6 style="padding: 0.5em 0em 0.5em 0em;margin:0">Expected output:</h6>\n\n`;

                //            if exercise_details["output_type"] == "txt"
                //                test_output += `<pre style="padding: 0.5em 0em 0.5em 0em;margin:0">exercise_details["tests"][test_title]["txt_output"]</pre>`;
                //            else
                //                test_output += `<p style="padding: 0.5em 0em 0.5em 0em;margin:0"><figure class='img'><img src='data:image/jpg;base64,` + 'exercise_details["tests"][test_title]["jpg_output"]' + `' width='100%' /></figure></p>`;

                //            if (json_data != null && json_data.tests[test_title].diff_output != "") {
                //                test_output += `<h6 style="padding: 0.5em 0em 0.5em 0em;margin:0">Difference between your output and the expected output:</h6>\n\n`;

                //                if exercise_details["output_type"] == "txt"
                //                     test_output += `<pre style="padding: 0.5em 0em 0.5em 0em;margin:0">` + json_data.tests[test_title].diff_output + "</pre>\n\n";
                //                     test_output += `<p style="padding: 0.5em 0em 0.5em 0em;margin:0"><em>A <code>+</code> in brackets indicates that your output had an extra character.<br />A <code>-</code> in brackets indicates that your output was missing the specified character.</em></p>`;
                //                else
                //                     test_output += `<p style="padding: 0.5em 0em 0.5em 0em;margin:0"><figure class='img'><img src='data:image/jpg;base64,` + json_data.tests[test_title].diff_output + `' width='100%' /></figure></p><br />`;
                //            }
                //        else
                //            test_output += `<h6 style="padding: 0.5em 0em 0.5em 0em;margin:0">Details for this test are hidden from students.`;

                //            if exercise_details["tests"][test_title]["test_instructions"] != ""
                //                test_output += ` However, the instructor provided the following instructions.</h6>`;
                //                test_output += `<p style="padding: 0.5em 0em 0.5em 0em;margin:0">exercise_details["tests"][test_title]["test_instructions"]</p>`;
                //            else
                //                test_output += "</h6>";

                //        if (json_data != null) {
                //            test_output += `<h6 style="padding: 0.5em 0em 0.5em 0em;margin:0">Your output:</h6>\n\n`;

                //            if exercise_details["output_type"] == "txt"
                //                if (json_data.tests[test_title].txt_output == "")
                //                    test_output += `<pre style="padding: 0.5em 0em 0.5em 0em;margin:0">[Your solution produced no output.]</pre>`;
                //                else
                //                    test_output += `<pre style="padding: 0.5em 0em 0.5em 0em;margin:0">${json_data.tests[test_title].txt_output}</pre>`;
                //            else
                //                if (json_data.tests[test_title]["jpg_output"] == "")
                //                    test_output += `<pre style="padding: 0.5em 0em 0.5em 0em;margin:0">[Your solution did not produce an image.]</pre>`;
                //                else
                //                    test_output += "<p><figure class='img'><img src='data:image/jpg;base64," + json_data.tests[test_title].jpg_output + "' width='100%' /></figure></p>";

                //                if (json_data.tests[test_title]["txt_output"] != "")
                //                    test_output += `<pre style="padding: 0.5em 0em 0.5em 0em;margin:0">${json_data.tests[test_title].txt_output}</pre>`;
                //        }

                //        test_output += `</div></div>`
                //        test_output += `<br />`

                //        document.getElementById("test_output").innerHTML = test_output;
                //}

                function build_txt_output(json_output) {
                    var output = "";

                    if (json_output == "") {
                        // if exercise_details["output_type"] == "txt" 
                        //    output = "<p><pre>[Your solution produced no output.]</pre></p>";
                        //else
                        //    output = "";
                    }
                    else {
                        output = "<p><pre>" + json_output + "</pre></p>";
                    }

                    return output;
                }

                function build_jpg_output(json_output) {
                    var output = "";

                    if (json_output == "")
                        {% if exercise_details["output_type"] == "jpg" %}
                            output = "<p><pre>[Your solution did not produce an image.]</pre></p>";
                        {% else %}
                            output = "";
                        {% end %}
                    else
                        output = "<p><figure class='img'><img src='data:image/jpg;base64," + json_output + "' width='100%' /></figure></p>";

                    return output;
                }

                ace.require("ace/ext/language_tools");
                var editor = ace.edit("user_code", {
                    theme: "ace/theme/{{ user_info['ace_theme'] }}",
                    autoScrollEditorIntoView: false,
                    minLines: 20,
                    fontSize: "12pt"
                });
                let codeChanged = false

                editor.session.on('change', function(delta) {
                  codeChanged = true
                });

                {% if user_info['enable_vim'] %}
                   editor.setKeyboardHandler("ace/keyboard/vim");
                {% end %}

                {% if user_info["use_auto_complete"] and exercise_details["back_end"] != "not_code" %}
                    editor.setOptions({
                        enableBasicAutocompletion: false,
                        enableSnippets: true,
                        enableLiveAutocompletion: true
                    });
                {% end %}

                editor.focus();
                editor.getSession().setMode("{{ code_completion_path }}");

                // Autosave if code has changed
                setInterval(function() {
                    if (codeChanged) {
                        save_presubmission(true);
                    }
                }, 60 * 1000);

                submitButton = document.getElementById("submit_button");

                {% if exercise_details["enable_pair_programming"] %}
                      if (submitButton != null)
                          submitButton.onclick = function() {
                              submitModal()
                      }
                {% else %}
                    if (submitButton != null) {
                        submitButton.onclick = function() {
                        submit()
                    }
                }
                {% end %}

                const tests = JSON.parse("{{ tests_json }}");
                showTestOutputs(null);
            </script>
        {% else %}
            <p>This exercise does not exist.</p>
        {% end %}
    {% else %}
        <p>This assignment does not exist.</p>
    {% end %}
{% else %}
    <p>This course does not exist.</p>
{% end %}
